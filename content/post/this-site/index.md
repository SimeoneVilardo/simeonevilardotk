---
title: This site
date: 2021-02-19
tags: ["hugo","nginx","security"]
---

This site&apos;s server is running on a Raspberry Pi 3.
These pages are static content generated by Hugo and served by Nginx Proxy,
which acts as a reverse proxy and allows the Raspberry to keep multiple web servers in production.
Nginx is configured to serve all content via http2 ssl.

## Prerequisites
Raspberry Pi with installed Raspbian and shell access. Raspbian Lite is fine, we don't need GUI. Passwordless (with only publickey enabled) SSH access is recommended. I won't cover how to set up SSH.

## Why not Docker

Docker is great, but the images for the Raspberry Pi are often outdated.

## Security goals

The goal is to set up a production-ready server. There are some best practice 
which are fundamental.
* Don't run anything as root
    * Use a non-sudo user on the Raspberry Pi
    * Install a non-sudo version of Nginx
    * Install a non-sudo version of NodeJs
* Keep evereything updated
    * The Raspberry Pi OS must be updated
    * Nginx must be updated
* Fix the default Nginx configuration


## Update the OS

First things first, we have to make sure the OS is updated.
Open the command prompt, type:  
```
sudo apt-get update
```
Then, type:  
```
sudo apt-get upgrade
```

## Create a new non-sudo user
Create a new user, by typing:  
```
sudo adduser [username]
```
Then add the user to the non-sudo user grup, with the command:  
```
sudo adduser [username] users
```
You can now logout  
```
logout
```  
And you can login with the new credentials. Now you can try run:  
```
sudo apt-get update
```
The expcted behaveiur is to get an error:

> [username] is not in the sudoers file.  This incident will be reported.

In the future we'll alse use the sudo-enabled user.

## Install nginx
We want nginx to run as non-sudo user, so we can't install nginx with `apt-get`. Furthermore, the default version of nginx with `apt-get` is 1.14.2, which is outdated. We'll download the latest version of the source, and compile them under the non-sudo user home directory. Create an "apps" directory. My working directory is `/home/server`. Create an `apps` directory, and enter it.
```
mkdir apps
cd apps
```
Download the latest source, which should be `http://nginx.org/download/nginx-[version].tar.gz`. The current version at the time of writing is 1.19.7. You can check the latest mainlane versione here: https://nginx.org/en/download.html.
```
wget http://nginx.org/download/nginx-1.19.7.tar.gz
```
Extract the tar archive. 
```
tar xvf nginx-1.19.7.tar.gz
```
Rename the newly-created nginx directory
```
mv nginx-1.19.7 nginx
```
Delete the tar file, we don't need this anymore
```
rm nginx-1.19.7.tar.gz
```
Change directory to the nginx directory. 
```
cd nginx
``` 
Now start the configuration. Here’s a common configuration arguments for nginx mainline version. Change the `[username]` with your non-sudo username.
```
./configure \
--prefix=/home/[username]/apps/nginx                                         \
--sbin-path=/home/[username]/apps/nginx/sbin/nginx                           \
--conf-path=/home/[username]/apps/nginx/nginx.conf                           \
--error-log-path=/home/[username]/var/log/nginx/error.log                    \
--http-log-path=/home/[username]/var/log/nginx/access.log                    \
--pid-path=/home/[username]/var/run/nginx.pid                                \
--lock-path=/home/[username]/var/run/nginx.lock                              \
--http-client-body-temp-path=/home/[username]/var/cache/nginx/client_temp    \
--http-proxy-temp-path=/home/[username]/var/cache/nginx/proxy_temp           \
--http-fastcgi-temp-path=/home/[username]/var/cache/nginx/fastcgi_temp       \
--http-uwsgi-temp-path=/home/[username]/var/cache/nginx/uwsgi_temp           \
--http-scgi-temp-path=/home/[username]/var/cache/nginx/scgi_temp             \
--with-http_ssl_module                                             	         \
--with-http_realip_module                                                    \
--with-http_addition_module                                                  \
--with-http_sub_module                                                       \
--with-http_dav_module                                                       \
--with-http_flv_module                                                       \
--with-http_mp4_module                                                       \
--with-http_gunzip_module                                                    \
--with-http_gzip_static_module                                               \
--with-http_random_index_module                                              \
--with-http_secure_link_module                                               \
--with-http_stub_status_module                                               \
--with-http_auth_request_module                                              \
--with-file-aio                                                              \
--with-http_v2_module                                                        \
--with-threads                                                               \
--with-stream                                                                \
--with-stream_ssl_module                                                     \
--with-http_slice_module
``` 
Now let’s compile it with make.  
```
make
``` 
Then install it  
```
make install
```
If you see this error  
> nginx: [emerg] mkdir() "/home/[username]/var/cache/nginx/client_temp" failed (2: No such file or directory)  

Then manually create the directory `/home/[username]/var/cache/nginx`.  
Now we have to create a service to handle the most useds commands, like "start", "stop", "reload" and "check config".  
First you have to enable lingering for the non-sudo user. This is needed to startup the user service on boot. **As sudo-user** execute:
```
loginctl enable-linger [username]
```
Create a diretory for the services:
```
mkdir -p ~/.config/systemd/user
```
Create a service file, you can use nano.
```
nano nginx.service
```
And paste this:
```
[Unit]
Description=The NGINX HTTP and reverse proxy server
After=syslog.target network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/home/[username]/var/run/nginx.pid
ExecStartPre=/home/[username]//apps/nginx/sbin/nginx -t
ExecStart=/home/[username]//apps/nginx/sbin/nginx
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
User=[username]
Group=users

[Install]
WantedBy=default.target
```
Now reload the configuration and enable the service. Again as non-sudo execute the commands.
```
systemctl --user daemon-reload
systemctl --user enable nginx.service
systemctl --user start nginx.service
```
You can also you the command `systemctl --user status nginx` to check the nginx status.

{{< figure
img="nginx_status.png" 
caption="This is an example of correct status" 
command="Resize" 
options="923x" >}}

## Some shorcut
It's useful to set up some aliases for the most common commands.